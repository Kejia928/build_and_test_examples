# name: build-and-test

# on:
#   push:
#     branches: [ main ]

# jobs:
#   build:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout repo
#         uses: actions/checkout@v4

#       - name: Install build deps
#         run: |
#           sudo apt-get update
#           sudo apt-get install -y g++ make

#       - name: Build fibonacci
#         run: |
#           cd cpp
#           make fibonacci

#       - name: Upload build artifacts
#         uses: actions/upload-artifact@v4
#         with:
#           name: cpp-build
#           path: |
#             cpp/fibonacci

#   test:
#     runs-on: ubuntu-latest
#     needs: build
#     steps:
#       - name: Checkout repo
#         uses: actions/checkout@v4

#       - name: Install test deps
#         run: |
#           sudo apt-get update
#           sudo apt-get install -y g++ make cmake libcppunit-dev libgtest-dev

#       - name: Download build artifacts
#         uses: actions/download-artifact@v4
#         with:
#           name: cpp-build
#           path: cpp

#       - name: Run fibonacci
#         run: |
#           cd cpp
#           chmod +x ./fibonacci
#           ./fibonacci 30

#       - name: Run CppUnit tests
#         run: |
#           cd cpp
#           make test
#           test -f TestResults.xml
#           cat TestResults.xml

#       - name: Run googletest tests
#         run: |
#           cd cpp
#           make googletest
#           test -f TestResults.xml
#           cat TestResults.xml


name: test

on:
  push:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip cmake make g++

      # -------------------------
      # Install CppUnit (README way)
      # -------------------------
      - name: Install CppUnit
        run: |
          wget http://dev-www.libreoffice.org/src/cppunit-1.13.2.tar.gz
          tar -xvzf cppunit-1.13.2.tar.gz
          cd cppunit-1.13.2
          ./configure --prefix=$HOME
          make
          make install
          export CPLUS_INCLUDE_PATH=$HOME/include:$CPLUS_INCLUDE_PATH
          export LIBRARY_PATH=$HOME/lib:$LIBRARY_PATH
          export LD_LIBRARY_PATH=$HOME/lib:$LD_LIBRARY_PATH

      # -------------------------
      # Install googletest (README way)
      # -------------------------
      - name: Install googletest
        run: |
          wget https://github.com/google/googletest/archive/release-1.7.0.zip
          unzip release-1.7.0.zip
          cd googletest-release-1.7.0
          mkdir build
          cd build
          cmake .. -Dgtest_disable_pthreads=ON
          make
          mkdir -p $HOME/include
          cp -r ../include/gtest/ $HOME/include/
          mkdir -p $HOME/lib
          cp libgtest*a $HOME/lib/
          export CPLUS_INCLUDE_PATH=$HOME/include:$CPLUS_INCLUDE_PATH
          export LIBRARY_PATH=$HOME/lib:$LIBRARY_PATH
          export LD_LIBRARY_PATH=$HOME/lib:$LD_LIBRARY_PATH

      # -------------------------
      # Build and run (README Usage)
      # -------------------------
      - name: Compile and run
        run: |
          cd cpp
          make fibonacci
          ./fibonacci 30
          make test
          cat TestResults.xml
          make googletest
          cat TestResults.xml
          make clean
